<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheda di Lavorazione - Design Colorato</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: sans-serif; /* Modificato da 'Inter' a un font generico */
            background-color: #f1f5f9; /* slate-100 */
        }
        .form-container {
            max-width: 21cm;
            margin: 1cm auto 0 auto;
        }
        .a4-sheet {
            width: 21cm;
            min-height: 29.7cm; /* Si espande se il contenuto è maggiore */
            padding: 1.2cm;
            margin: 1cm auto;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
        }
        .main-table {
            table-layout: fixed;
        }
        th, td {
            border: 1px solid #e5e7eb;
            padding: 0; 
            text-align: left;
            vertical-align: top;
            font-size: 0.55rem;
            line-height: 1.3;
            word-wrap: break-word;
        }
        th {
            padding: 0.2rem 0.3rem;
            font-weight: 600;
            background-color: #f8fafc; /* slate-50 */
            color: #475569; /* slate-600 */
            text-align: center;
            font-size: 0.6rem;
        }
        .editable-content {
            padding: 0.2rem 0.3rem;
            width: 100%;
            height: 100%;
            min-height: 2.5em;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .editable-content:focus {
            outline: 1px solid #60a5fa; /* blue-400 */
        }
        .input-field {
             padding: 0.2rem 0.3rem;
        }

        .section-title {
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 0.2rem;
            padding: 0.2rem;
            border: 1px solid #1e293b; /* slate-800 */
            background-color: #1e293b; /* slate-800 */
            color: white;
        }
        .subsection-title {
            font-size: 0.65rem;
            font-weight: 600;
            text-align: center;
            padding: 0.15rem;
            border: 1px solid #e2e8f0; /* slate-200 */
            background-color: #f1f5f9; /* slate-100 */
            color: #334155; /* slate-700 */
            margin-bottom: 0.1rem;
        }
        #header-data-table td {
             border: 1px solid #9ca3af;
             padding: 3px 5px;
             font-size: 0.6rem;
        }
        .custom-checkbox-label {
            font-size: 0.55rem;
        }
        .custom-checkbox {
            height: 0.7rem;
            width: 0.7rem;
        }

        @media print {
            body { background-color: #fff; }
            .a4-sheet { width: 100%; min-height: 29.7cm; padding: 0.5cm; margin: 0; box-shadow: none; }
            .no-print { display: none !important; }
            [contenteditable]:focus { outline: none; }
        }
    </style>
</head>
<body class="p-2">
    <!-- Interfaccia di compilazione -->
    <div class="form-container no-print bg-white p-4 rounded-lg shadow-md">
        <div class="flex justify-between items-center mb-3">
            <h2 class="text-xl font-bold text-slate-700">Pannello di Controllo</h2>
            <button id="toggle-form-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-1 px-3 rounded text-xs">Nascondi</button>
        </div>
        <div id="form-body">
            <!-- Dati Intestazione -->
            <fieldset class="border border-slate-300 p-3 rounded-md mb-4">
                <legend class="text-sm font-semibold px-2 text-slate-600">Dati Intestazione</legend>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                    <div>
                        <label for="input-cliente" class="block font-medium text-slate-700">Cliente</label>
                        <input type="text" id="input-cliente" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" value="BAUSANO">
                    </div>
                    <div>
                        <label for="input-disegno" class="block font-medium text-slate-700">Disegno N°</label>
                        <input type="text" id="input-disegno" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" value="TR17M030Z2">
                    </div>
                    <div>
                        <label for="input-descrizione" class="block font-medium text-slate-700">Descrizione</label>
                        <input type="text" id="input-descrizione" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" value="ALBERO PIGNONE MOTORE ELICA SX">
                    </div>
                    <div>
                        <label for="input-materiale" class="block font-medium text-slate-700">Materiale</label>
                        <input type="text" id="input-materiale" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                    </div>
                    <div>
                        <label for="input-foglio" class="block font-medium text-slate-700">N° Foglio Dis.</label>
                        <input type="text" id="input-foglio" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                    </div>
                    <div>
                        <label for="input-data" class="block font-medium text-slate-700">Data Emissione</label>
                        <input type="date" id="input-data" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                    </div>
                     <div>
                        <label for="input-pezzi-lavorare" class="block font-medium text-slate-700">N° Pezzi da Lavorare</label>
                        <input type="number" id="input-pezzi-lavorare" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                    </div>
                    <div>
                        <label for="input-pezzi-campionati" class="block font-medium text-slate-700">N° Pezzi Campionati</label>
                        <input type="number" id="input-pezzi-campionati" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                    </div>
                    <div>
                        <label for="input-pezzi-consegnati" class="block font-medium text-slate-700">N° Pezzi Consegnati</label>
                        <input type="number" id="input-pezzi-consegnati" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                    </div>
                </div>
            </fieldset>
            <!-- Descrizione Lavorazioni -->
            <fieldset class="border border-slate-300 p-3 rounded-md">
                <legend class="text-sm font-semibold px-2 text-slate-600">Descrizione Lavorazioni</legend>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <label for="input-tornitura" class="block font-medium text-slate-700">Tornitura CNC</label>
                        <textarea id="input-tornitura" rows="2" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm"></textarea>
                    </div>
                    <div>
                        <label for="input-fresatura" class="block font-medium text-slate-700">Fresatura CNC</label>
                        <textarea id="input-fresatura" rows="2" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm"></textarea>
                    </div>
                    <div>
                        <label for="input-altre" class="block font-medium text-slate-700">Altre Lavorazioni</label>
                        <textarea id="input-altre" rows="3" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm"></textarea>
                    </div>
                    <div>
                        <label for="input-trattamenti" class="block font-medium text-slate-700">Trattamenti Esterni</label>
                        <textarea id="input-trattamenti" rows="3" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label for="input-lavorazioni-esterne" class="block font-medium text-slate-700">Lavorazioni Esterne</label>
                        <textarea id="input-lavorazioni-esterne" rows="2" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm"></textarea>
                    </div>
                 </div>
            </fieldset>
        </div>
    </div>

    <div class="a4-sheet" id="a4-sheet">
        <!-- Bottone JPG posizionato in modo assoluto -->
        <div class="no-print" style="position: absolute; top: 0.4cm; right: 0.4cm;">
            <button onclick="downloadJPG()" class="bg-slate-700 hover:bg-slate-800 text-white font-bold py-1 px-2 rounded text-xs">Salva JPG</button>
        </div>

        <!-- Intestazione -->
        <header class="flex-shrink-0 mb-2">
            <div class="flex justify-between items-start mb-1">
                <div class="w-1/4">
                    <div class="border-2 border-blue-500 bg-blue-50 px-2 py-1 text-center">
                        <div class="font-semibold text-sm tracking-wide text-blue-800">COMMESSA</div>
                        <div id="commessa-input" contenteditable="true" class="text-lg font-bold p-0 focus:outline-none bg-transparent">202348</div>
                    </div>
                </div>
                <div class="w-1/2 text-center pt-1">
                    <h1 class="text-2xl font-bold text-slate-800 leading-tight">SCHEDA DI LAVORAZIONE</h1>
                </div>
                <div class="w-1/4 flex flex-col items-end">
                     <div class="w-full h-12 border-2 border-slate-400 flex items-center justify-center text-gray-400 text-xs p-1">
                         <svg id="barcode"></svg>
                     </div>
                    <p class="text-xs mt-1 text-slate-500">Mod. SDL - Ed. 01/04/07- Pag. 1 / 2</p>
                </div>
            </div>
            <table id="header-data-table" class="border-2 border-slate-400">
                <tbody>
                    <tr>
                        <td id="display-cliente"><span class="font-semibold">CLIENTE:</span> BAUSANO</td>
                        <td id="display-disegno"><span class="font-semibold">DISEGNO N°:</span> TR17M030Z2</td>
                        <td id="display-descrizione"><span class="font-semibold">DESCRIZIONE:</span> ALBERO PIGNONE MOTORE ELICA SX</td>
                    </tr>
                    <tr>
                        <td id="display-materiale"><span class="font-semibold">MATERIALE:</span></td>
                        <td id="display-foglio"><span class="font-semibold">N° FOGLIO DIS.:</span></td>
                        <td id="display-data"><span class="font-semibold">DATA EMISSIONE:</span></td>
                    </tr>
                    <tr>
                        <td id="display-pezzi-lavorare"><span class="font-semibold">N° PEZZI DA LAVORARE:</span></td>
                        <td id="display-pezzi-campionati"><span class="font-semibold">N° PEZZI CAMPIONATI:</span></td>
                        <td id="display-pezzi-consegnati"><span class="font-semibold">N° PEZZI CONSEGNATI:</span></td>
                    </tr>
                </tbody>
            </table>
        </header>

        <!-- Sezione Principale Flessibile -->
        <div class="flex-grow flex flex-col">
            <!-- Sezione 1: Ciclo di Lavoro (cresce per riempire lo spazio) -->
            <section class="flex-grow flex flex-col">
                <h2 class="section-title">SEZ.1: CICLO DI LAVORO E CONTROLLO</h2>
                <table class="h-full main-table">
                    <thead>
                        <tr>
                            <th style="width: 50%;">OP / Descrizione</th>
                            <th style="width: 20%;">Caratteristiche da controllare</th>
                            <th style="width: 15%;">Freq. / Campionature / Resp.</th>
                            <th style="width: 8%;">Strumenti</th>
                            <th style="width: 7%;">Toll.</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- TAGLIO MATERIALE -->
                        <tr>
                            <td class="editable-cell"><div contenteditable="true" class="editable-content"><span class="font-semibold">10 - TAGLIO MATERIALE</span><br>Materiale m.d./e foglio</div></td>
                            <td class="editable-cell"><div contenteditable="true" class="editable-content">Lunghezza come da disegno ± 5 mm da pz finito</div></td>
                            <td class="editable-cell"><div contenteditable="true" class="editable-content">Contr.: 100% dei pz.<br>Reg.: N°1 Pz/100.</div></td>
                            <td class="editable-cell"><div contenteditable="true" class="editable-content">Calibro, Metro</div></td>
                            <td class="editable-cell"><div contenteditable="true" class="editable-content">-5</div></td>
                        </tr>
                        <!-- TORNITURA -->
                        <tr>
                            <td class="editable-cell"><div id="display-tornitura-desc" contenteditable="true" class="editable-content"></div></td>
                            <td class="editable-cell"><div contenteditable="true" class="editable-content">Tutte le quote a disegno.<br>Quote a disegno con tolleranze centesimali.</div></td>
                            <td class="editable-cell"><div contenteditable="true" class="editable-content">Contr.: 10% dei pz. Reg.: N°1 Pz/100.<br>Contr.: 100% dei pz. Reg.: N°1 Pz/100.</div></td>
                            <td class="editable-cell"><div contenteditable="true" class="editable-content">Calibro, Micrometro, Alesametro</div></td>
                            <td class="editable-cell"><div contenteditable="true" class="editable-content">Vedi disegno</div></td>
                        </tr>
                        <!-- FRESATURA -->
                        <tr>
                            <td class="editable-cell"><div id="display-fresatura-desc" contenteditable="true" class="editable-content"></div></td>
                            <td class="editable-cell"><div contenteditable="true" class="editable-content">Tutte le quote a disegno.<br>Quote a disegno con tolleranze centesimali.</div></td>
                            <td class="editable-cell"><div contenteditable="true" class="editable-content">Contr.: 10% dei pz. Reg.: N°1 Pz/100.<br>Contr.: 100% dei pz. Reg.: N°1 Pz/100.</div></td>
                            <td class="editable-cell"><div contenteditable="true" class="editable-content">Calibro, Micrometro, Alesametro</div></td>
                            <td class="editable-cell"><div contenteditable="true" class="editable-content">Vedi disegno</div></td>
                        </tr>
                        <!-- ALTRE LAVORAZIONI -->
                        <tr class="h-full">
                            <td class="editable-cell"><div id="display-altre-desc" contenteditable="true" class="editable-content h-full"></div></td>
                            <td colspan="4" class="editable-cell"><div contenteditable="true" class="editable-content h-full"></div></td>
                        </tr>
                        <!-- TRATTAMENTI ESTERNI -->
                        <tr>
                           <td class="editable-cell"><div id="display-trattamenti-desc" contenteditable="true" class="editable-content"></div></td>
                            <td colspan="4" class="editable-cell"><div contenteditable="true" class="editable-content text-center">Vedi "Istruzioni di Controllo Accettazione" (Doc. ICA)</div></td>
                        </tr>
                        <!-- LAVORAZIONI ESTERNE -->
                        <tr>
                           <td class="editable-cell"><div id="display-lavorazioni-esterne-desc" contenteditable="true" class="editable-content"></div></td>
                            <td colspan="4" class="editable-cell"><div contenteditable="true" class="editable-content text-center"></div></td>
                        </tr>
                        <!-- CONTROLLI FINALI -->
                        <tr>
                            <td class="editable-cell"><div contenteditable="true" class="editable-content"><span class="font-semibold">CONTROLLI FINALI</span><br><br></div></td>
                            <td colspan="4" class="editable-cell"><div contenteditable="true" class="editable-content"><b class="text-gray-800">RESPONSABILITA': CONTROLLO QUALITA'</b><br>Verificare tutte le caratteristiche già controllate nel processo con la seguente campionatura: 100% fino a 3 pezzi, 2% per quantità superiori. Registrare su "Certificato di Qualità e Conformità" (Mod. CQC) Se richiesto.</div></td>
                        </tr>
                    </tbody>
                </table>
            </section>
        </div>

        <!-- Parte Inferiore Fissa -->
        <div class="flex-shrink-0">
            <!-- Avvertenze -->
            <section class="mt-2 mb-1">
                <div class="bg-yellow-50 border border-yellow-300 text-yellow-800 rounded-lg p-1">
                    <h3 class="font-bold text-center text-xs mb-0.5">AVVERTENZE IN CASO DI NON CONFORMITA'</h3>
                    <div class="space-y-0 text-[0.45rem] leading-tight text-yellow-700 px-2">
                        <div class="flex items-start"><span class="mr-1">1.</span><span>Arrestare la lavorazione.</span></div>
                        <div class="flex items-start"><span class="mr-1">2.</span><span>Identificare i particolari non conformi con il cartellino "Prodotto in Sospeso" (Mod. PS) e collocarli nell'area "Prodotto In Sospeso".</span></div>
                        <div class="flex items-start"><span class="mr-1">3.</span><span>Avvisare il Responsabile Tecnico e Produzione o il Controllo Qualità.</span></div>
                        <div class="flex items-start"><span class="mr-1">4.</span><span>Riprendere la lavorazione solo dopo il ripristino delle condizioni di idoneità del processo effettuate dal Resp. Tecnico e Produzione.</span></div>
                    </div>
                </div>
            </section>
            
            <!-- Registrazione 1° Pezzo -->
            <section class="my-1">
                <h3 class="subsection-title">REGISTRAZIONE CONTROLLI 1° PEZZO (TOLLERANZE DECIMALI E CENTESIMALI)</h3>
                <table>
                    <tbody id="registrazione-primo-pezzo-body"></tbody>
                </table>
            </section>

            <!-- Sezione 2: Registrazioni in fase di lavorazione -->
            <section class="my-1">
                <h2 class="subsection-title">SEZ. 2: CONTROLLI IN FASE DI LAVORAZIONE</h2>
                <div class="text-[0.55rem] mb-1 text-gray-600">FASE/PZ.CONTROLLT.OGNI VOLTA IN CASO DI REG. di LT LAVORAZIONE</div>
                <div id="registrazione-in-processo-grid" class="grid grid-cols-4 gap-2"></div>
            </section>
            
            <!-- Footer -->
            <footer class="flex-shrink-0 pt-1 border-t-2 border-slate-800 text-xs">
                <div class="flex justify-between items-center w-full">
                    <span class="font-semibold">Emesso da: RESP. TECNICO E PRODUZIONE</span>
                    <div class="w-1/3 h-6 border-b border-black"></div>
                </div>
            </footer>
        </div>
    </div>

    <!-- Librerie per Barcode e Screenshot -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // Funzione per generare il codice a barre
        function generateBarcode(value) {
            if (value) {
                try {
                    JsBarcode("#barcode", value, {
                        format: "CODE128",
                        lineColor: "#000",
                        width: 1.5,
                        height: 30,
                        displayValue: false,
                        margin: 0
                    });
                } catch (e) {
                    console.error("Invalid barcode value", e);
                    document.getElementById('barcode').innerHTML = '';
                }
            } else {
                 document.getElementById('barcode').innerHTML = '';
            }
        }

        // Funzione per generare le righe della tabella "Registrazione 1° Pezzo"
        function generatePrimoPezzoRows() {
            const container = document.getElementById('registrazione-primo-pezzo-body');
            if (!container) return;
            let html = '<tr>';
            const headers = ['OP N°', 'DATA', 'ESITO', 'FIRMA'];
            for (let i = 0; i < 2; i++) {
                headers.forEach(h => html += `<th>${h}</th>`);
            }
            html += '</tr>';
            for (let i = 0; i < 4; i++) {
                html += '<tr>';
                for (let j = 0; j < 2; j++) {
                    html += `
                        <td class="editable-cell"><div contenteditable="true" class="editable-content input-field"></div></td>
                        <td class="editable-cell"><div contenteditable="true" class="editable-content input-field"></div></td>
                        <td style="padding: 0.2rem 0.3rem;">
                            <div class="flex justify-center items-center gap-1">
                                <label class="custom-checkbox-label flex items-center gap-1"><input type="checkbox" class="custom-checkbox">OK</label>
                                <label class="custom-checkbox-label flex items-center gap-1"><input type="checkbox" class="custom-checkbox">NOK</label>
                            </div>
                        </td>
                        <td class="editable-cell"><div contenteditable="true" class="editable-content input-field"></div></td>
                    `;
                }
                html += '</tr>';
            }
            container.innerHTML = html;
        }

        // Funzione per generare i box di controllo "In Fase di Lavorazione"
        function generateInProcessoBoxes() {
            const container = document.getElementById('registrazione-in-processo-grid');
            if (!container) return;
            let html = '';
            for (let i = 0; i < 8; i++) {
                html += `
                <div class="border border-gray-300 rounded-md p-0.5 space-y-px text-[0.5rem]">
                    <div class="flex justify-between items-center"><span>OP:</span><div contenteditable="true" class="editable-content input-field w-1/2 p-0.5" style="min-height: 1em;"></div></div>
                    <div class="flex justify-center space-x-2 py-px">
                        <label class="custom-checkbox-label flex items-center gap-1"><input type="checkbox" class="custom-checkbox">OK</label>
                        <label class="custom-checkbox-label flex items-center gap-1"><input type="checkbox" class="custom-checkbox">NOK</label>
                    </div>
                    <div class="flex justify-between items-center"><span>Data:</span><div class="w-2/3 h-1 border-b border-dotted border-gray-400"></div></div>
                    <div class="flex justify-between items-center"><span>Firma:</span><div class="w-2/3 h-1 border-b border-dotted border-gray-400"></div></div>
                </div>
                `;
            }
            container.innerHTML = html;
        }

        // Funzione per scaricare lo screenshot in JPG
        function downloadJPG() {
            const sheet = document.getElementById('a4-sheet');
            
            const noPrintElements = document.querySelectorAll('.no-print');
            noPrintElements.forEach(el => el.style.display = 'none');

            // Rimuovi temporaneamente il focus per nascondere i bordi blu
            const activeElement = document.activeElement;
            if (activeElement) {
                activeElement.blur();
            }

            html2canvas(sheet, { scale: 2, useCORS: true, logging: false })
                .then(canvas => {
                    const link = document.createElement('a');
                    link.download = 'scheda-lavorazione.jpg';
                    link.href = canvas.toDataURL("image/jpeg", 0.9); // 0.9 è la qualità
                    link.click();
                    
                    noPrintElements.forEach(el => el.style.display = '');
                });
        }
        
        // Collega il form alla scheda
        function setupFormListeners() {
            const mappings = [
                // Intestazione
                { inputId: 'input-cliente', displayId: 'display-cliente', label: 'CLIENTE:' },
                { inputId: 'input-disegno', displayId: 'display-disegno', label: 'DISEGNO N°:' },
                { inputId: 'input-descrizione', displayId: 'display-descrizione', label: 'DESCRIZIONE:' },
                { inputId: 'input-materiale', displayId: 'display-materiale', label: 'MATERIALE:' },
                { inputId: 'input-foglio', displayId: 'display-foglio', label: 'N° FOGLIO DIS.:' },
                { inputId: 'input-data', displayId: 'display-data', label: 'DATA EMISSIONE:', isDate: true },
                { inputId: 'input-pezzi-lavorare', displayId: 'display-pezzi-lavorare', label: 'N° PEZZI DA LAVORARE:' },
                { inputId: 'input-pezzi-campionati', displayId: 'display-pezzi-campionati', label: 'N° PEZZI CAMPIONATI:' },
                { inputId: 'input-pezzi-consegnati', displayId: 'display-pezzi-consegnati', label: 'N° PEZZI CONSEGNATI:' },
                // Lavorazioni
                { inputId: 'input-tornitura', displayId: 'display-tornitura-desc', title: 'TORNITURA CNC', defaultBr: 2 },
                { inputId: 'input-fresatura', displayId: 'display-fresatura-desc', title: 'FRESATURA CNC', defaultBr: 2 },
                { inputId: 'input-altre', displayId: 'display-altre-desc', title: 'ALTRE LAVORAZIONI', defaultBr: 8 },
                { inputId: 'input-trattamenti', displayId: 'display-trattamenti-desc', title: 'TRATTAMENTI ESTERNI', defaultBr: 2 },
                { inputId: 'input-lavorazioni-esterne', displayId: 'display-lavorazioni-esterne-desc', title: 'LAVORAZIONI ESTERNE', defaultBr: 2 },
            ];

            mappings.forEach(m => {
                const inputElement = document.getElementById(m.inputId);
                const displayElement = document.getElementById(m.displayId);

                if (inputElement && displayElement) {
                    const updateDisplay = () => {
                        if (m.label) { // Campi intestazione
                            let value = inputElement.value;
                            if (m.isDate && value) {
                                const parts = value.split('-');
                                if (parts.length === 3 && parts[0].length === 4) {
                                   value = `${parts[2]}/${parts[1]}/${parts[0]}`;
                                }
                            }
                            displayElement.innerHTML = `<span class="font-semibold">${m.label}</span> ${value || ''}`;
                        } else if (m.title) { // Campi lavorazioni
                            const sanitizedValue = inputElement.value.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, '<br>');
                            let content = `<span class="font-semibold">${m.title}</span>`;
                            if (sanitizedValue) {
                                content += `<br>${sanitizedValue}`;
                            } else {
                                content += '<br>'.repeat(m.defaultBr || 1);
                            }
                            displayElement.innerHTML = content;
                        }
                    };
                    
                    inputElement.addEventListener('input', updateDisplay);
                    // Inizializza il valore al caricamento
                    updateDisplay();
                }
            });
            
            // Gestione bottone Nascondi/Mostra
            const toggleBtn = document.getElementById('toggle-form-btn');
            const formBody = document.getElementById('form-body');
            toggleBtn.addEventListener('click', () => {
                const isHidden = formBody.style.display === 'none';
                formBody.style.display = isHidden ? '' : 'none';
                toggleBtn.textContent = isHidden ? 'Nascondi' : 'Mostra';
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            generatePrimoPezzoRows();
            generateInProcessoBoxes();
            setupFormListeners(); 

            // Setup barcode generation
            const commessaInput = document.getElementById('commessa-input');
            commessaInput.addEventListener('input', (e) => generateBarcode(e.target.textContent));
            generateBarcode(commessaInput.textContent);
        });
    </script>
</body>
</html>
